---
title: "@hardlydifficult/workflow-engine"
description: "API reference for @hardlydifficult/workflow-engine"
---

# @hardlydifficult/workflow-engine

General-purpose state machine with typed statuses, validated transitions, and persistent state.

## Installation

```bash
npm install @hardlydifficult/workflow-engine @hardlydifficult/state-tracker
```

## Usage

```typescript
import { WorkflowEngine } from "@hardlydifficult/workflow-engine";

type Status = "idle" | "running" | "completed" | "failed";
interface Data { count: number; result?: string; }

const engine = new WorkflowEngine<Status, Data>({
  key: "my-workflow",
  initialStatus: "idle",
  initialData: { count: 0 },
  transitions: {
    idle: ["running", "failed"],
    running: ["completed", "failed"],
    completed: [],
    failed: [],
  },
  stateDirectory: "/var/data",
  onTransition: (event) => console.log(`${event.from} -> ${event.to}`),
});

await engine.load();

await engine.transition("running", (draft) => {
  draft.count = 1;
});

await engine.transition("completed", (draft) => {
  draft.result = "done";
});

engine.isTerminal; // true
```

## API

### `new WorkflowEngine<TStatus, TData>(options)`

| Option | Type | Description |
|--------|------|-------------|
| `key` | `string` | Unique persistence key |
| `initialStatus` | `TStatus` | Default status for new workflows |
| `initialData` | `TData` | Default data for new workflows |
| `transitions` | `Record<TStatus, TStatus[]>` | Allowed transitions per status |
| `stateDirectory` | `string?` | Persistence directory |
| `autoSaveMs` | `number?` | Auto-save interval (default 5000) |
| `onTransition` | `function?` | Event callback |

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `status` | `TStatus` | Current status |
| `data` | `Readonly<TData>` | Current data |
| `isLoaded` | `boolean` | Whether `load()` has been called |
| `isPersistent` | `boolean` | Whether disk storage is available |
| `isTerminal` | `boolean` | Whether current status has no outgoing transitions |

### Methods

| Method | Description |
|--------|-------------|
| `load()` | Load persisted state from disk. Safe to call multiple times. |
| `transition(to, updater?)` | Change status, optionally mutate data. Validates transition, persists immediately. |
| `update(updater)` | Mutate data without changing status. Persists immediately. |
| `save()` | Force-save current state to disk. |
| `canTransition(to)` | Check if a transition is allowed from current status. |
| `allowedTransitions()` | List statuses reachable from current status. |

### Updater Pattern

`transition()` and `update()` accept an updater callback that receives a `structuredClone` of the data. Mutate it directly â€” if the updater throws, nothing changes.

```typescript
await engine.transition("running", (draft) => {
  draft.count += 1;
  draft.result = computeResult();
});
```
